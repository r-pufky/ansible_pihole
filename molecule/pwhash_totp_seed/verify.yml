---
- name: 'Verify'
  hosts: 'all'
  gather_facts: false
  tasks:
    - name: 'Verify | query /etc/pihole/pihole.toml.broken'
      ansible.builtin.stat:
        path: '/etc/pihole/pihole.toml.broken'
      register: _pihole_test

    - name: 'Verify | assert /etc/pihole/pihole.toml.broken absent'
      when: _pihole_test.stat.exists
      ansible.builtin.debug:
        msg: |
          ╭───────────────────────────────────────────────────────────────────╮
          │                                                                   │
          │                     pihole.toml.broken exists                     │
          │                                                                   │
          ├───────────────────────────────────────────────────────────────────╯
          │ /etc/pihole/pihole.toml.broken should not exist.
          │
          │ There was an error rendering the configuration file which PiHole
          │ had to re-write with defaults. See below.

    - name: 'Verify | /etc/pihole/pihole.toml'
      when: _pihole_test.stat.exists
      ansible.builtin.include_role:
        name: 'r_pufky.lib.tests'
        tasks_from: 'remote_file_diff.yml'
      vars:
        test_name: 'Verify | /etc/pihole/pihole.toml'
        test_remote_src: '/etc/pihole/pihole.toml'
        test_file: '/etc/pihole/pihole.toml.broken'
        test_owner: '123'
        test_group: '123'
        test_mode: '0644'
        test_diff: true

    - name: 'Verify | REST API auth OK'
      ansible.builtin.uri:
        url: 'https://localhost:443/api/auth'
        method: 'POST'
        status_code: [200]
        body:
          password: 'test2'
        body_format: 'json'
        validate_certs: false
      register: _pihole_api
