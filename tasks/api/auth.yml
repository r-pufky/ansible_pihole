---
###############################################################################
# API Auth
###############################################################################
# Authenticate session to PiHole REST API.
#
# Generates:
#   _pihole.token: str - validated auth token.
#   _pihole.csrf: str - CSRF session token.

- name: 'API | auth | 2FA token'
  when: _pihole_cfg_webserver_api_app_pwhash.raw | length == 0
  block:
    - name: 'API | auth | ACTION REQUIRED ðŸ—˜'
      ansible.builtin.debug:
        msg: |
          â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
          â”‚                                                                   â”‚
          â”‚                        2FA Token Required.                        â”‚
          â”‚                                                                   â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
          â”‚ Enter token below (no time limit).

    - name: 'API | auth | 2FA token | read token'
      ansible.builtin.pause:
        echo: true
      register: _pihole_totp

    - name: 'API | auth | 2FA token | create session'
      block:
        - name: 'API | auth | 2FA token | create session'
          ansible.builtin.uri:
            url: '{{ _pihole_srv_api.raw ~ "/auth" }}'
            method: 'POST'
            status_code: [200]
            body: '{
                "password": "{{ _pihole_cfg_webserver_api_pwhash.raw }}",
                "totp": {{ _pihole_totp.user_input | int }}
              }'
            body_format: 'json'
            validate_certs: '{{ _pihole_srv_api_validate_enable.raw }}'
          register: _pihole_api

    - name: 'API | auth | cache token'
      ansible.builtin.set_fact:
        _pihole: '{{
            _pihole |
            combine({"token": _pihole_api.json.session.sid,
                     "csrf": _pihole_api.json.session.csrf})
          }}'
  rescue:
    - name: 'API | auth | FAILED âš '
      ansible.builtin.fail:
        msg: |
          â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
          â”‚                                                                   â”‚
          â”‚                    API Authentication failed.                     â”‚
          â”‚                                                                   â”‚
          â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
          {{ _pihole.status_code }}: {{ _pihole_api.msg }}

- name: 'API | auth | create session'
  when: _pihole_cfg_webserver_api_app_pwhash.raw | length > 0
  block:
    - name: 'API | auth | create session'
      ansible.builtin.uri:
        url: '{{ _pihole_srv_api.raw ~ "/auth" }}'
        method: 'POST'
        status_code: [200]
        body:
          password: '{{ _pihole_cfg_webserver_api_app_pwhash.raw }}'
        body_format: 'json'
        validate_certs: '{{ _pihole_srv_api_validate_enable.raw }}'
      register: _pihole_api

    - name: 'API | auth | cache tokens'
      ansible.builtin.set_fact:
        _pihole: '{{
            _pihole |
            combine({"token": _pihole_api.json.session.sid,
                     "csrf": _pihole_api.json.session.csrf})
          }}'
  rescue:
    - name: 'API | auth | FAILED âš '
      ansible.builtin.fail:
        msg: |
          â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
          â”‚                                                                   â”‚
          â”‚                    API Authentication failed.                     â”‚
          â”‚                                                                   â”‚
          â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
          {{ _pihole.status_code }}: {{ _pihole_api.msg }}
